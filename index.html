<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NextScore Match Center</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg1:#fbf7ef;
      --bg2:#eef4ff;
      --card:#ffffff;
      --text:#0e1420;
      --muted:#5f6b7a;
      --line:rgba(15,25,40,.10);
      --shadow: 0 18px 60px rgba(0,0,0,.10);
      --shadow2: 0 10px 30px rgba(0,0,0,.08);
      --radius: 26px;
      --accent:#f59a17;
      --accent2:#ffb44c;
      --good:#18a34a;
      --warn:#f59e0b;
      --bad:#ef4444;
      --pill:#f4f6fb;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Roboto, system-ui, -apple-system, Segoe UI, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 600px at 20% 15%, rgba(245,154,23,.18), transparent 60%),
        radial-gradient(900px 600px at 75% 5%, rgba(70,120,255,.16), transparent 60%),
        linear-gradient(135deg, var(--bg1) 0%, var(--bg2) 70%);
      min-height:100vh;
    }
    .wrap{
      width:min(1200px, calc(100% - 44px));
      margin: 40px auto 70px;
    }
    h1{
      margin:0;
      font-size: clamp(36px, 4.6vw, 64px);
      line-height:1.05;
      letter-spacing:-.02em;
    }
    .brand-accent{color:var(--accent)}
    .sub{
      margin:12px 0 0;
      font-size: clamp(16px, 1.5vw, 20px);
      color:var(--muted);
      max-width: 820px;
    }

    .panel{
      margin-top:24px;
      background: rgba(255,255,255,.62);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 22px;
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }
    .controls{
      display:grid;
      grid-template-columns: 1.25fr auto;
      gap:16px;
      align-items:end;
    }
    .control{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    label{
      color:#2b3646;
      font-weight:800;
      font-size:14px;
    }
    select, input{
      width:100%;
      height:52px;
      border-radius: 18px;
      border:1px solid rgba(15,25,40,.12);
      background: rgba(255,255,255,.90);
      padding: 0 14px;
      font-size:16px;
      outline:none;
      box-shadow: 0 10px 24px rgba(0,0,0,.05);
    }
    .hint{
      color:var(--muted);
      font-size:13px;
      margin-top:-4px;
    }
    .btn{
      height:52px;
      border-radius: 18px;
      border:0;
      cursor:pointer;
      padding: 0 22px;
      font-weight:900;
      font-size:18px;
      color:#1b1202;
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent2) 100%);
      box-shadow: 0 18px 44px rgba(245,154,23,.35);
    }
    .btn:active{transform: translateY(1px)}
    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:14px;
    }
    .chip{
      background: var(--pill);
      border:1px solid rgba(15,25,40,.10);
      padding:10px 12px;
      border-radius:999px;
      font-size:14px;
      color:#334155;
      display:flex;
      align-items:center;
      gap:8px;
      font-weight:700;
    }
    .chip b{color:#111827}

    .grid{
      margin-top:22px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:18px;
    }
    @media (max-width: 960px){
      .controls{grid-template-columns:1fr}
      .grid{grid-template-columns:1fr}
    }

    .card{
      background: rgba(255,255,255,.78);
      border: 1px solid var(--line);
      border-radius: 26px;
      box-shadow: var(--shadow2);
      padding: 18px;
      position:relative;
      overflow:hidden;
      min-height: 200px;
    }
    .card h3{
      margin:0;
      font-size: 24px;
      letter-spacing:-.01em;
    }
    .meta{
      margin-top:6px;
      color: var(--muted);
      font-weight:700;
    }
    .badge{
      position:absolute;
      right:16px;
      top:16px;
      padding: 7px 10px;
      border-radius: 999px;
      font-weight:900;
      font-size: 13px;
      border:1px solid rgba(15,25,40,.12);
      background: rgba(255,255,255,.8);
      color:#111827;
    }
    .badge.live{color:#065f46; border-color: rgba(6,95,70,.18); background: rgba(16,185,129,.10);}
    .badge.next{color:#1f3b8a; border-color: rgba(31,59,138,.18); background: rgba(59,130,246,.10);}

    .teams{
      margin-top:14px;
      border:1px solid rgba(15,25,40,.10);
      border-radius: 18px;
      background: rgba(255,255,255,.85);
      padding: 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .team{
      display:flex;
      align-items:center;
      gap:12px;
      min-width: 0;
      flex:1;
    }
    .team.right{justify-content:flex-end}
    .logo{
      width:44px;height:44px;border-radius:999px;
      border:1px solid rgba(15,25,40,.12);
      background: rgba(255,255,255,.95);
      object-fit: contain;
      padding: 6px;
      flex:0 0 auto;
    }
    .tname{
      font-size:18px;
      font-weight:900;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .vs{
      flex:0 0 auto;
      font-weight:900;
      color:#7c4a00;
      background: rgba(245,154,23,.16);
      border:1px solid rgba(245,154,23,.28);
      padding: 6px 10px;
      border-radius: 999px;
      min-width: 44px;
      text-align:center;
    }

    .cta{
      margin-top:14px;
      display:flex;
      justify-content:center;
    }
    .cta button{
      border:0;
      cursor:pointer;
      border-radius: 18px;
      padding: 14px 18px;
      width: min(360px, 100%);
      font-size: 18px;
      font-weight: 900;
      color:#1b1202;
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent2) 100%);
      box-shadow: 0 18px 44px rgba(245,154,23,.32);
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
    }

    /* Modal */
    .overlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.46);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 9999;
    }
    .overlay.show{display:flex}
    .modal{
      width: min(980px, 100%);
      max-height: min(86vh, 900px);
      background: rgba(255,255,255,.88);
      border:1px solid rgba(255,255,255,.55);
      border-radius: 26px;
      box-shadow: 0 30px 120px rgba(0,0,0,.25);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }
    .modalHead{
      padding: 14px 18px;
      background: rgba(251, 240, 224, .88);
      border-bottom:1px solid rgba(15,25,40,.08);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .mhLeft{
      display:flex;
      align-items:center;
      gap:12px;
      min-width: 0;
    }
    .botBadge{
      width:38px;height:38px;border-radius:999px;
      border:1px solid rgba(15,25,40,.12);
      background: rgba(255,255,255,.92);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
    }
    .mhTitle{
      display:flex;
      flex-direction:column;
      min-width:0;
    }
    .mhTitle b{
      font-size:18px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .mhTitle span{color:var(--muted); font-weight:700; margin-top:2px}
    .closeBtn{
      border:1px solid rgba(15,25,40,.12);
      background: rgba(255,255,255,.9);
      border-radius: 999px;
      padding: 10px 14px;
      font-weight: 900;
      cursor:pointer;
    }

    .tabs{
      padding: 12px 14px;
      background: rgba(255,255,255,.66);
      border-bottom:1px solid rgba(15,25,40,.08);
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .tab{
      border:1px solid rgba(15,25,40,.12);
      background: rgba(255,255,255,.90);
      border-radius: 999px;
      padding: 10px 14px;
      font-weight: 900;
      cursor:pointer;
      color:#111827;
    }
    .tab.active{
      border-color: rgba(245,154,23,.42);
      background: rgba(245,154,23,.12);
      color:#7c4a00;
    }

    .chat{
      padding: 14px;
      overflow:auto;
      flex:1;
      background: rgba(255,255,255,.66);
    }
    .msg{
      max-width: 820px;
      border:1px solid rgba(15,25,40,.10);
      background: rgba(255,255,255,.92);
      border-radius: 18px;
      padding: 12px 14px;
      box-shadow: 0 10px 24px rgba(0,0,0,.05);
      margin: 10px 0;
      white-space: pre-wrap;
      line-height:1.35;
    }
    .msg.me{
      margin-left:auto;
      background: rgba(15,25,40,.92);
      color:#fff;
      border-color: rgba(15,25,40,.20);
    }
    .msg .small{
      display:block;
      color: var(--muted);
      font-weight:800;
      font-size: 12px;
      margin-bottom: 6px;
    }
    .msg.me .small{color: rgba(255,255,255,.75)}
    .warnBox{
      border:1px solid rgba(245,158,11,.25);
      background: rgba(245,158,11,.10);
    }

    .composer{
      padding: 12px 14px;
      border-top:1px solid rgba(15,25,40,.08);
      background: rgba(255,255,255,.88);
      display:flex;
      gap:12px;
    }
    .composer input{
      height:54px;
      border-radius: 18px;
      flex:1;
      font-size: 16px;
      padding: 0 14px;
    }
    .sendBtn{
      height:54px;
      border-radius: 18px;
      border:0;
      cursor:pointer;
      padding: 0 18px;
      font-weight: 900;
      font-size: 18px;
      color:#1b1202;
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent2) 100%);
      box-shadow: 0 18px 44px rgba(245,154,23,.30);
      min-width: 120px;
    }

    /* Typing indicator */
    .typing{
      display:inline-flex;
      align-items:center;
      gap:10px;
    }
    .typing .dots{
      display:inline-flex;
      gap:6px;
      align-items:center;
    }
    .typing .dots i{
      width:8px;height:8px;border-radius:50%;
      background:#94a3b8;
      display:inline-block;
      animation: b 1.1s infinite ease-in-out;
      opacity:.6;
    }
    .typing .dots i:nth-child(2){animation-delay:.15s}
    .typing .dots i:nth-child(3){animation-delay:.30s}
    @keyframes b{
      0%, 80%, 100% { transform: translateY(0); opacity:.45 }
      40% { transform: translateY(-4px); opacity:1 }
    }

    .errorBox{
      margin-top:18px;
      padding: 16px;
      border-radius: 18px;
      border:1px solid rgba(239,68,68,.22);
      background: rgba(239,68,68,.08);
      display:none;
    }
    .errorBox.show{display:block}
    .errorBox b{color:#7f1d1d}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
  </style>
</head>

<body>
  <div class="wrap">
    <h1>NextScore <span class="brand-accent">Match Center</span></h1>
    <p class="sub">
      Seleziona una competizione e leggi l‚Äôanalisi di Betty <b>con dati reali</b> (classifica, forma, marcatori, indisponibili).
    </p>

    <div class="panel">
      <div class="controls">
        <div class="control">
          <label>Competizione</label>
          <select id="preset">
            <optgroup label="üáÆüáπ Italia">
              <option value="serieA" selected>Serie A</option>
              <option value="serieB">Serie B</option>
              <option value="coppaItalia">Coppa Italia</option>
            </optgroup>

            <optgroup label="üá™üá∏ Spagna">
              <option value="laliga">LaLiga</option>
            </optgroup>

            <optgroup label="üá´üá∑ Francia">
              <option value="ligue1">Ligue 1</option>
            </optgroup>

            <optgroup label="üá©üá™ Germania">
              <option value="bundesliga">Bundesliga</option>
            </optgroup>

            <optgroup label="üá™üá∫ Coppe Europee">
              <option value="ucl">Champions League</option>
              <option value="uel">Europa League</option>
              <option value="uecl">Conference League</option>
            </optgroup>

            <optgroup label="üåç Mondiali">
              <option value="worldcup">World Cup</option>
              <option value="euro">Europei (EURO)</option>
            </optgroup>
          </select>
          <div class="hint">Tabellone da API-Football. (Quote rimosse sotto le partite.)</div>
        </div>

        <button class="btn" id="btnLoad">Aggiorna Match</button>
      </div>

      <div class="chips">
        <div class="chip">match: <b id="chipCount">0</b></div>
        <div class="chip">modalit√†: <b id="chipMode">live/next</b></div>
        <div class="chip">AI: <b>Betty ü§ñ</b></div>
        <div class="chip">dati: <b>standings</b> ‚Ä¢ <b>form</b> ‚Ä¢ <b>injuries</b> ‚Ä¢ <b>scorers</b></div>
      </div>

      <div class="errorBox" id="errorBox">
        <b>‚ùå Errore</b>
        <div class="mono" id="errorText" style="margin-top:8px;"></div>
      </div>
    </div>

    <div class="grid" id="grid"></div>
  </div>

  <!-- MODAL -->
  <div class="overlay" id="overlay">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalHead">
        <div class="mhLeft">
          <div class="botBadge">ü§ñ</div>
          <div class="mhTitle">
            <b id="mhMatch">‚Äî</b>
            <span id="mhWhen">‚Äî</span>
          </div>
        </div>
        <button class="closeBtn" id="btnClose">Chiudi</button>
      </div>

      <div class="tabs">
        <button class="tab active" data-mode="analisi">Analisi</button>
        <button class="tab" data-mode="uo">Under/Over</button>
        <button class="tab" data-mode="btts">Gol/NoGol</button>
        <button class="tab" data-mode="cs">Risultato Esatto</button>
        <button class="tab" data-mode="scorer">Marcatore</button>
      </div>

      <div class="chat" id="chat"></div>

      <div class="composer">
        <input id="q" placeholder="(opzionale) fai una domanda a Betty‚Ä¶" />
        <button class="sendBtn" id="btnSend">Invia</button>
      </div>
    </div>
  </div>

  <script>
    /***********************
     * CONFIG
     ***********************/
    const API_BASE   = "https://football-hub-299332443653.europe-west8.run.app";
    const BETTY_BASE = "https://betty-chat-299332443653.europe-west8.run.app";

    /***********************
     * PRESET (manuali)
     ***********************/
    const PRESETS = {
      // üáÆüáπ Italia
      serieA:      { league: 135, season: 2025 },
      serieB:      { league: 136, season: 2025 },
      coppaItalia: { league: 137, season: 2025 },

      // üá™üá∏ Spagna
      laliga:      { league: 140, season: 2025 },

      // üá´üá∑ Francia
      ligue1:      { league: 61,  season: 2025 },

      // üá©üá™ Germania
      bundesliga:  { league: 78,  season: 2025 },

      // üá™üá∫ Coppe Europee
      ucl:         { league: 2,   season: 2025 },
      uel:         { league: 3,   season: 2025 },
      uecl:        { league: 848, season: 2025 },

      // üåç Mondiali
      worldcup:    { league: 1,   season: 2022 },
      euro:        { league: 4,   season: 2024 }
    };

    /***********************
     * STATE
     ***********************/
    const S = {
      presetKey: "serieA",
      fixtures: [],
      current: null,
      currentMode: "analisi",
      currentContext: null,
      answersByMode: {},
      typingEl: null,
      inflightToken: 0
    };

    const $ = (id) => document.getElementById(id);

    function showError(msg){
      $("errorText").textContent = msg;
      $("errorBox").classList.add("show");
    }
    function clearError(){
      $("errorBox").classList.remove("show");
      $("errorText").textContent = "";
    }

    function fmtDate(d){
      try{
        const dt = new Date(d);
        return dt.toLocaleString("it-IT", { weekday:"short", day:"2-digit", month:"short", hour:"2-digit", minute:"2-digit" });
      }catch(e){ return d || "‚Äî"; }
    }

    function norm(s){ return String(s||"").trim().toLowerCase(); }

    function escapeHtml(str){
      return String(str||"")
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;")
        .replace(/'/g,"&#039;")
        .replace(/\n/g,"<br/>");
    }

    // ‚úÖ L/D/W ‚Üí S/P/V nelle sequenze tipo L-D-L-L-W
    function translateFormSequences(text){
      const map = { "L":"S", "D":"P", "W":"V" };
      return String(text||"").replace(/\b([LDW](?:-[LDW]){1,})\b/g, (m)=>{
        return m.split("-").map(ch => map[ch] || ch).join("-");
      });
    }

    // ‚úÖ H2H ‚Üí Scontri diretti
    function translateH2H(text){
      return String(text||"").replace(/\bH2H\b/gi, "Scontri diretti");
    }

    function postProcessBotText(text){
      let t = String(text||"");
      t = translateH2H(t);
      t = translateFormSequences(t);
      return t;
    }

    function addMsg(who, text, isWarn=false){
      const el = document.createElement("div");
      el.className = "msg " + (who === "me" ? "me" : "") + (isWarn ? " warnBox" : "");
      const label = who === "me" ? "Tu" : "Betty";
      const finalText = (who === "me") ? text : postProcessBotText(text);
      el.innerHTML = `<span class="small">${label}</span>${escapeHtml(finalText)}`;
      $("chat").appendChild(el);
      $("chat").scrollTop = $("chat").scrollHeight;
      return el;
    }

    function showTyping(){
      hideTyping();
      const el = document.createElement("div");
      el.className = "msg";
      el.innerHTML = `
        <span class="small">Betty</span>
        <span class="typing">
          <span>Betty sta scrivendo</span>
          <span class="dots"><i></i><i></i><i></i></span>
        </span>
      `;
      $("chat").appendChild(el);
      $("chat").scrollTop = $("chat").scrollHeight;
      S.typingEl = el;
    }
    function hideTyping(){
      if(S.typingEl && S.typingEl.parentNode){
        S.typingEl.parentNode.removeChild(S.typingEl);
      }
      S.typingEl = null;
    }

    async function apiGet(path){
      const url = API_BASE + path;
      const r = await fetch(url, { method:"GET" });
      if(!r.ok){
        const txt = await r.text().catch(()=> "");
        throw new Error(`${r.status} ${r.statusText} ‚Äî ${url}\n${txt}`);
      }
      return r.json();
    }

    async function bettyChat(payload){
      const tryUrls = [
        BETTY_BASE.replace(/\/$/,"") + "/chat",
        BETTY_BASE.replace(/\/$/,"") + "/"
      ];
      let lastErr = null;
      for(const url of tryUrls){
        try{
          const r = await fetch(url, {
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body: JSON.stringify(payload)
          });
          if(!r.ok){
            const t = await r.text().catch(()=> "");
            throw new Error(`${r.status} ${r.statusText} ‚Äî ${url}\n${t}`);
          }
          return r.json();
        }catch(e){
          lastErr = e;
        }
      }
      throw lastErr || new Error("Failed to fetch betty-chat");
    }

    async function loadFixtures(){
      clearError();
      const preset = PRESETS[S.presetKey];

      try{
        const next = 20; // 20 match
        const data = await apiGet(`/fixtures?league=${preset.league}&season=${preset.season}&next=${next}`);
        const list = data?.response || data?.fixtures || data?.data || (Array.isArray(data) ? data : []);
        S.fixtures = Array.isArray(list) ? list : [];
        $("chipCount").textContent = String(S.fixtures.length);
        renderGrid();
      }catch(e){
        showError("Errore /fixtures: " + e.message);
      }
    }

    function renderGrid(){
      const g = $("grid");
      g.innerHTML = "";

      for(const fx of S.fixtures){
        const fixtureId = fx?.fixture?.id || fx?.fixture_id || fx?.id || "";
        const homeName = fx?.teams?.home?.name || fx?.home?.name || fx?.home_team?.name || "Home";
        const awayName = fx?.teams?.away?.name || fx?.away?.name || fx?.away_team?.name || "Away";
        const date = fx?.fixture?.date || fx?.date || "";
        const status = norm(fx?.fixture?.status?.short || fx?.status || "");
        const isLive = ["1h","2h","ht","et","p","live","inplay"].includes(status);

        const homeLogo = fx?.teams?.home?.logo || fx?.home?.logo || "";
        const awayLogo = fx?.teams?.away?.logo || fx?.away?.logo || "";

        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div class="badge ${isLive ? "live":"next"}">${isLive ? "live":"next"}</div>
          <h3>${homeName} <span style="color:#8b97a8;font-weight:900;">vs</span> ${awayName}</h3>
          <div class="meta">${fmtDate(date)}</div>

          <div class="teams">
            <div class="team">
              ${homeLogo ? `<img class="logo" src="${homeLogo}" alt="" />` : ``}
              <div class="tname">${homeName}</div>
            </div>
            <div class="vs">VS</div>
            <div class="team right">
              <div class="tname">${awayName}</div>
              ${awayLogo ? `<img class="logo" src="${awayLogo}" alt="" />` : ``}
            </div>
          </div>

          <div class="cta">
            <button data-fixture="${fixtureId}">Leggi il Pronostico di Betty ü§ñ</button>
          </div>
        `;

        card.querySelectorAll("img.logo").forEach(img=>{
          img.onerror = ()=> img.style.display="none";
        });

        card.querySelector("button").addEventListener("click", async () => {
          await openModalForFixture(fx);
        });

        g.appendChild(card);
      }
    }

    /***********************
     * AUTO-ANSWER per tab
     ***********************/
    const MODE_DEFAULT_USER_PROMPT = {
      analisi: "Analizza il match e dammi l'esito pi√π probabile.",
      uo:      "Consiglia Under/Over pi√π coerente (2.5/3.5 se ha senso).",
      btts:    "Consiglia Gol/NoGol (BTTS) pi√π coerente.",
      cs:      "Proponi 1-2 risultati esatti plausibili.",
      scorer:  "Proponi 1-3 marcatori plausibili."
    };

    function systemRulesForMode(mode){
      return [
        "REGOLE IMPORTANTI:",
        "- Usa SOLO i dati presenti nel JSON 'context' allegato.",
        "- Se un dato non c'√®, scrivi: 'Dato non disponibile nel contesto'.",
        "- Non inventare statistiche, nomi o quote se non sono nel contesto.",
        "- Rispondi in italiano, breve e concreto.",
        "",
        "OUTPUT richiesto:",
        mode === "analisi" ? "1) contesto (classifica+forma) 2) indisponibili chiave 3) scenario + esito pi√π probabile" :
        mode === "uo" ? "1) linea consigliata (Under/Over) 2) breve motivazione" :
        mode === "btts" ? "1) Gol o NoGol 2) breve motivazione" :
        mode === "cs" ? "1) 1-2 risultati esatti 2) breve logica" :
        mode === "scorer" ? "1) 1-3 marcatori 2) motivazione usando SOLO topscorers/indisponibili nel context" :
        "Risposta breve"
      ].join("\n");
    }

    async function runAutoAnswerForMode(mode){
      if(!S.current) return;

      if(S.answersByMode[mode]){
        return;
      }

      if(!S.currentContext){
        const txt = "Non disponibile: il contesto del match non √® arrivato (standings/forma/indisponibili/marcatori).";
        addMsg("bot", txt, true);
        S.answersByMode[mode] = txt;
        return;
      }

      const token = ++S.inflightToken;
      showTyping();

      const fixtureId = S.current?.fixture?.id || S.current?.fixture_id || S.current?.id || null;
      const home = S.current?.teams?.home?.name || S.current?.home?.name || S.current?.home_team?.name;
      const away = S.current?.teams?.away?.name || S.current?.away?.name || S.current?.away_team?.name;
      const date = (S.current?.fixture?.date || S.current?.date || "").slice(0,10);

      const payload = {
        prompt: MODE_DEFAULT_USER_PROMPT[mode] || "Dammi un pronostico coerente.",
        mode,
        system: systemRulesForMode(mode),
        match: { fixture_id: fixtureId, home, away, date },
        context: S.currentContext
      };

      try{
        const res = await bettyChat(payload);
        if(token !== S.inflightToken) return;

        const out =
          res?.answer ||
          res?.text ||
          res?.message ||
          (typeof res === "string" ? res : JSON.stringify(res, null, 2));

        hideTyping();
        addMsg("bot", out);
        S.answersByMode[mode] = out;

      }catch(e){
        if(token !== S.inflightToken) return;
        hideTyping();
        const txt = "Non disponibile: errore nel generare la risposta per questa modalit√†.";
        addMsg("bot", txt, true);
        S.answersByMode[mode] = txt;
      }
    }

    function setActiveTab(mode){
      S.currentMode = mode;
      document.querySelectorAll(".tab").forEach(t => {
        t.classList.toggle("active", t.dataset.mode === mode);
      });
      runAutoAnswerForMode(mode);
    }

    async function openModalForFixture(fx){
      S.current = fx;
      S.currentContext = null;
      S.answersByMode = {};
      S.inflightToken++;

      const homeName = fx?.teams?.home?.name || fx?.home?.name || fx?.home_team?.name || "Home";
      const awayName = fx?.teams?.away?.name || fx?.away?.name || fx?.away_team?.name || "Away";
      const date = fx?.fixture?.date || fx?.date || "";
      const fixtureId = fx?.fixture?.id || fx?.fixture_id || fx?.id || "";

      $("mhMatch").textContent = `${homeName}  vs  ${awayName}`;
      $("mhWhen").textContent = fmtDate(date);
      $("chat").innerHTML = "";

      $("overlay").classList.add("show");

      showTyping();
      try{
        const ctx = await apiGet(`/context?fixture=${encodeURIComponent(fixtureId)}`);
        S.currentContext = ctx;
        hideTyping();

        setActiveTab(S.currentMode);

      }catch(e){
        hideTyping();
        addMsg("bot", "Non disponibile: non riesco a caricare il contesto del match.", true);
        setActiveTab(S.currentMode);
      }
    }

    async function sendUserQuestion(){
      const text = $("q").value.trim();
      if(!text) return;
      $("q").value = "";
      addMsg("me", text);

      if(!S.currentContext){
        addMsg("bot","Non disponibile: non ho il contesto del match.", true);
        return;
      }

      const mode = S.currentMode;
      const token = ++S.inflightToken;
      showTyping();

      const fixtureId = S.current?.fixture?.id || S.current?.fixture_id || S.current?.id || null;
      const home = S.current?.teams?.home?.name || S.current?.home?.name || S.current?.home_team?.name;
      const away = S.current?.teams?.away?.name || S.current?.away?.name || S.current?.away_team?.name;
      const date = (S.current?.fixture?.date || S.current?.date || "").slice(0,10);

      try{
        const res = await bettyChat({
          prompt: text,
          mode,
          system: systemRulesForMode(mode),
          match: { fixture_id: fixtureId, home, away, date },
          context: S.currentContext
        });

        if(token !== S.inflightToken) return;
        hideTyping();

        const out =
          res?.answer ||
          res?.text ||
          res?.message ||
          (typeof res === "string" ? res : JSON.stringify(res, null, 2));

        addMsg("bot", out);

      }catch(e){
        if(token !== S.inflightToken) return;
        hideTyping();
        addMsg("bot","Non disponibile: errore nel generare la risposta.", true);
      }
    }

    /***********************
     * Events
     ***********************/
    document.querySelectorAll(".tab").forEach(t => {
      t.addEventListener("click", () => setActiveTab(t.dataset.mode));
    });

    $("btnClose").addEventListener("click", () => $("overlay").classList.remove("show"));
    $("overlay").addEventListener("click", (e) => { if(e.target === $("overlay")) $("overlay").classList.remove("show"); });
    document.addEventListener("keydown", (e) => { if(e.key === "Escape") $("overlay").classList.remove("show"); });

    $("btnSend").addEventListener("click", sendUserQuestion);
    $("q").addEventListener("keydown", (e)=>{ if(e.key === "Enter") sendUserQuestion(); });

    $("preset").addEventListener("change", (e) => {
      S.presetKey = e.target.value;
    });

    $("btnLoad").addEventListener("click", loadFixtures);

    async function boot(){
      await loadFixtures();
    }

    boot();
  </script>
</body>
</html>

</html>
