<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NextScore ‚Äî Match Center (Light)</title>

  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='64' height='64'><text y='50' font-size='50'>‚ö°</text></svg>">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;800;900&display=swap" rel="stylesheet"/>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{
      --bg:#ffffff;
      --panel:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:rgba(2,6,23,.10);
      --shadow: 0 16px 40px rgba(2,6,23,.08);
      --accent:#f59e0b;
      --accent2:#fb923c;
      --soft:#fff7ed;
    }
    html,body{ font-family:Roboto,system-ui,-apple-system,"Segoe UI",Arial,sans-serif; background:var(--bg); color:var(--text); }
    .cardShadow{ box-shadow: var(--shadow); }
    .chip{
      font-size:12px; line-height:1;
      padding:6px 10px; border-radius:999px;
      border:1px solid var(--border);
      background: #fff;
      color:#0f172a;
      white-space:nowrap;
    }
    .btn{
      border-radius:14px;
      padding:10px 14px;
      font-weight:800;
      border:1px solid var(--border);
      background:#fff;
      transition: transform .08s ease, box-shadow .12s ease;
    }
    .btn:hover{ transform: translateY(-1px); box-shadow:0 10px 24px rgba(2,6,23,.10); }
    .btnPrimary{
      border:1px solid rgba(245,158,11,.35);
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent2) 100%);
      color:#111827;
    }
    .btnPrimary:hover{ box-shadow:0 16px 40px rgba(245,158,11,.22); }
    .input{
      width:100%;
      border-radius:14px;
      border:1px solid var(--border);
      background:#fff;
      padding:10px 12px;
      color:#0f172a;
      outline:none;
    }
    .input:focus{
      border-color: rgba(245,158,11,.55);
      box-shadow: 0 0 0 4px rgba(245,158,11,.14);
    }

    .tlogo{
      width:34px;height:34px;border-radius:999px;
      display:inline-flex;align-items:center;justify-content:center;
      border:1px solid rgba(2,6,23,.10);
      background:#fff;
      overflow:hidden;
      flex:0 0 auto;
    }
    .tlogo img{ width:100%;height:100%;object-fit:contain; display:block; }
    .tlogo.fallback{
      font-weight:900;
      color:#0f172a;
      background:#f8fafc;
    }
    .vsPill{
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(2,6,23,.10);
      background:#fff7ed;
      font-weight:900;
      font-size:12px;
      color:#7c2d12;
    }

    .modalOverlay{
      position:fixed; inset:0;
      background: rgba(2,6,23,.45);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding:14px;
      z-index:9999;
    }
    .modalOverlay.show{ display:flex; }
    .modal{
      width:100%;
      max-width:980px;
      background:#fff;
      border:1px solid var(--border);
      border-radius:22px;
      box-shadow: 0 24px 70px rgba(2,6,23,.22);
      overflow:hidden;
      max-height: 92vh;
      display:flex;
      flex-direction:column;
    }
    .modalHeader{
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 16px;
      border-bottom:1px solid var(--border);
      background: linear-gradient(180deg, #ffffff 0%, #fffaf2 100%);
    }
    .avatar{
      width:34px; height:34px;
      border-radius:999px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      background: #fff7ed;
      border:1px solid rgba(245,158,11,.30);
      font-size:18px;
      flex:0 0 auto;
      overflow:hidden;
    }
    .modalBody{
      padding:14px 14px 0 14px;
      overflow:auto;
    }
    .chatFeed{
      padding:4px 2px 12px 2px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .bubbleRow{
      display:flex;
      gap:10px;
      align-items:flex-end;
    }
    .bubble{
      max-width: 820px;
      border-radius:18px;
      padding:10px 12px;
      border:1px solid var(--border);
      background:#fff;
      line-height:1.35;
      font-size:14px;
      white-space:pre-wrap;
    }
    .bubbleUser{
      margin-left:auto;
      background:#111827;
      color:#fff;
      border:1px solid rgba(2,6,23,.18);
    }
    .bubbleBetty{ background:#fff; }
    .miniName{
      font-size:12px;
      color:#0f172a;
      font-weight:900;
      margin-bottom:2px;
    }
    .microTabs{
      display:flex;
      gap:8px;
      padding:10px 14px 0 14px;
      flex-wrap:wrap;
    }
    .tabBtn{
      border-radius:999px;
      padding:8px 12px;
      font-weight:900;
      font-size:12px;
      border:1px solid var(--border);
      background:#fff;
      color:#0f172a;
    }
    .tabBtn.active{
      border-color: rgba(245,158,11,.50);
      background: #fff7ed;
    }
    .tabBtn.hidden{ display:none !important; }

    .modalFooter{
      border-top:1px solid var(--border);
      padding:10px 12px;
      display:flex;
      gap:10px;
      align-items:flex-end;
      background:#fff;
    }
    .textarea{
      width:100%;
      min-height:44px;
      max-height:120px;
      resize:none;
      border-radius:16px;
      border:1px solid var(--border);
      padding:10px 12px;
      outline:none;
      font-family:Roboto,system-ui,-apple-system,"Segoe UI",Arial,sans-serif;
    }
    .textarea:focus{
      border-color: rgba(245,158,11,.55);
      box-shadow: 0 0 0 4px rgba(245,158,11,.14);
    }

    .dbg{
      border:1px dashed rgba(2,6,23,.18);
      border-radius:16px;
      padding:12px;
      background:#fff;
    }
    .dbg pre{
      white-space:pre-wrap;
      word-break:break-word;
      font-size:12px;
      line-height:1.35;
      color:#0f172a;
      max-height:220px;
      overflow:auto;
      margin-top:8px;
      padding:10px;
      border-radius:12px;
      border:1px solid rgba(2,6,23,.10);
      background:#f8fafc;
    }

    @media (min-width: 900px){
      .modalOverlay{ align-items:center; }
      .modal{ max-height: 86vh; }
    }
  </style>
</head>

<body>
  <div class="max-w-6xl mx-auto px-4 py-6 md:py-8">
    <header class="flex items-start md:items-center justify-between gap-4 mb-6">
      <div>
        <h1 class="text-2xl md:text-3xl font-extrabold tracking-tight">
          NextScore <span class="text-amber-600">Match Center</span>
        </h1>
        <p class="text-sm md:text-base text-slate-600 mt-1">
          Seleziona un match e leggi l‚Äôanalisi di <strong>Betty</strong>
          <span class="text-slate-500">(con contesto: forma, classifica, marcatori, indisponibili)</span>.
        </p>
      </div>

      <div class="text-xs text-slate-500 text-right">
        <div id="rateInfo">rate: ‚Ä¶</div>
        <div id="statusInfo">stato: pronto</div>
      </div>
    </header>

    <section class="dbg mb-4">
      <div class="flex flex-wrap items-center justify-between gap-2">
        <div class="text-sm font-extrabold">Debug rapido</div>
        <div class="flex flex-wrap gap-2">
          <button class="btn" id="pingOdds">Ping get-odds</button>
          <button class="btn" id="pingHub">Ping football-hub</button>
          <button class="btn" id="pingBettyDirect">Ping betty diretto</button>
        </div>
      </div>
      <pre id="dbgOut">‚Äî</pre>
      <div class="text-[12px] text-slate-500 mt-2">
        Se vedi errori CORS o ‚ÄúFailed to fetch‚Äù, il problema √® l‚Äôorigin (file:// o dominio non autorizzato).
      </div>
    </section>

    <section class="bg-white rounded-2xl border cardShadow" style="border-color:var(--border);">
      <div class="p-4 md:p-5">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
          <div class="md:col-span-2">
            <label class="block text-sm font-bold text-slate-800 mb-1">Sport / Campionato</label>
            <select id="sport" class="input">
              <option value="soccer_italy_serie_a">Calcio ‚Äî Serie A</option>
              <option value="soccer_epl">Calcio ‚Äî Premier League</option>
              <option value="soccer_spain_la_liga">Calcio ‚Äî La Liga</option>
              <option value="soccer_germany_bundesliga">Calcio ‚Äî Bundesliga</option>
              <option value="soccer_france_ligue_one">Calcio ‚Äî Ligue 1</option>

              <option value="soccer_uefa_champs_league">UEFA ‚Äî Champions League</option>
              <option value="soccer_uefa_europa_league">UEFA ‚Äî Europa League</option>
              <option value="soccer_uefa_europa_conference_league">UEFA ‚Äî Conference League</option>

              <option value="basketball_nba">Basket ‚Äî NBA</option>
              <option value="tennis_atp">Tennis ‚Äî ATP</option>

              <option value="custom">‚Äî Altro (custom) ‚Äî</option>
            </select>
            <input id="sportCustom" type="text" class="input mt-2 hidden" placeholder="es. soccer_uefa_champs_league" />
            <div class="text-[12px] text-slate-500 mt-1">
              Se non trovi una competizione: usa ‚Äúcustom‚Äù e incolla la <strong>sport_key</strong>.
            </div>
          </div>

          <div>
            <label class="block text-sm font-bold text-slate-800 mb-1">Regione</label>
            <select id="regions" class="input">
              <option value="eu">EU</option>
              <option value="uk">UK</option>
              <option value="us">US</option>
              <option value="au">AU</option>
            </select>
          </div>

          <div class="flex items-end gap-2">
            <button id="refreshBtn" class="btn btnPrimary w-full">Aggiorna Match</button>
          </div>
        </div>

        <div class="mt-4 flex flex-wrap items-center gap-2">
          <span class="chip" id="chipCount">match: ‚Äî</span>
          <span class="chip" id="chipMode">modalit√†: live</span>
          <span class="chip">stile: light premium</span>
          <span class="chip">AI: Betty üßô‚Äç‚ôÄÔ∏è</span>
          <span class="chip" id="chipContext">context: ‚Äî</span>
        </div>
      </div>
    </section>

    <div id="notice" class="hidden mt-4 rounded-2xl border px-4 py-3 text-sm"
         style="border-color: rgba(245,158,11,.30); background: var(--soft); color:#7c2d12;">
    </div>

    <section id="cards" class="mt-5 grid gap-4 md:grid-cols-2"></section>
  </div>

  <div id="modalOverlay" class="modalOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Chat Betty">
      <div class="modalHeader">
        <div class="flex items-center gap-3">
          <div class="avatar" aria-hidden="true">üßô‚Äç‚ôÄÔ∏è</div>

          <div class="flex flex-col gap-1">
            <div class="text-sm font-extrabold leading-tight">Betty</div>

            <div class="flex items-center gap-2">
              <div id="mhHomeLogo" class="tlogo fallback" title="Home">H</div>
              <div id="mhHomeName" class="text-xs font-extrabold text-slate-800">‚Äî</div>
              <span class="vsPill">VS</span>
              <div id="mhAwayLogo" class="tlogo fallback" title="Away">A</div>
              <div id="mhAwayName" class="text-xs font-extrabold text-slate-800">‚Äî</div>
            </div>

            <div id="chatSub" class="text-xs text-slate-500">Seleziona un match per iniziare</div>
          </div>
        </div>

        <button id="closeModal" class="btn" style="padding:8px 12px;">Chiudi</button>
      </div>

      <div class="microTabs">
        <button class="tabBtn active" data-mode="OPEN" id="tabOPEN">Analisi</button>
        <button class="tabBtn" data-mode="TOTALS" id="tabTOTALS">Under/Over</button>
        <button class="tabBtn" data-mode="BTTS" id="tabBTTS">Gol/NoGol</button>
        <button class="tabBtn" data-mode="EXACT" id="tabEXACT">Risultato Esatto</button>
        <button class="tabBtn" data-mode="SCORER" id="tabSCORER">Marcatore</button>
      </div>

      <div class="modalBody">
        <div id="chatTitle" class="text-sm font-extrabold text-slate-900 mt-2 mb-2"></div>
        <div id="chatFeed" class="chatFeed"></div>
      </div>

      <div class="modalFooter">
        <textarea id="chatInput" class="textarea" rows="2" placeholder="Scrivi una domanda (es. 'Che partita sar√†?')"></textarea>
        <button id="sendBtn" class="btn btnPrimary" style="min-width:120px;">Invia</button>
      </div>
    </div>
  </div>

  <script>
    const ODDS_BASE = "https://get-odds-299332443653.europe-west8.run.app";
    const FOOTBALL_HUB_BASE = "https://football-hub-299332443653.europe-west8.run.app";
    const BETTY_BASE = "https://betty-chat-299332443653.europe-west8.run.app";
    const MAX_COUNT = 100;

    function buildDemoEvents(){
      const now = Date.now();
      const mk = (id, home, away, mins) => ({
        id,
        commence_time: new Date(now + mins*60*1000).toISOString(),
        home_team: home,
        away_team: away,
        outcomes: [
          { name:"Home", prob: null, odds: 1.90 },
          { name:"Draw", prob: null, odds: 3.40 },
          { name:"Away", prob: null, odds: 4.20 },
        ],
        totals: [
          { point: 2.5, outcomes:[ {name:"Over", prob:null, odds:1.75}, {name:"Under", prob:null, odds:1.93} ] }
        ],
      });
      return [
        mk("demo_1","Arsenal","Liverpool",90),
        mk("demo_2","Inter","Juventus",140),
        mk("demo_3","Real Madrid","Barcelona",210),
        mk("demo_4","PSG","Marseille",260),
      ];
    }

    const el = (id) => document.getElementById(id);
    const $ = {
      rate: el("rateInfo"),
      status: el("statusInfo"),
      notice: el("notice"),
      cards: el("cards"),
      chipCount: el("chipCount"),
      chipMode: el("chipMode"),
      chipContext: el("chipContext"),

      sport: el("sport"),
      sportCustom: el("sportCustom"),
      regions: el("regions"),
      refresh: el("refreshBtn"),

      overlay: el("modalOverlay"),
      closeModal: el("closeModal"),
      chatTitle: el("chatTitle"),
      chatSub: el("chatSub"),
      chatFeed: el("chatFeed"),
      chatInput: el("chatInput"),
      sendBtn: el("sendBtn"),

      tabBtns: Array.from(document.querySelectorAll(".tabBtn")),
      tabOPEN: el("tabOPEN"),
      tabTOTALS: el("tabTOTALS"),
      tabBTTS: el("tabBTTS"),
      tabEXACT: el("tabEXACT"),
      tabSCORER: el("tabSCORER"),

      mhHomeLogo: el("mhHomeLogo"),
      mhAwayLogo: el("mhAwayLogo"),
      mhHomeName: el("mhHomeName"),
      mhAwayName: el("mhAwayName"),

      dbgOut: el("dbgOut"),
      pingOdds: el("pingOdds"),
      pingHub: el("pingHub"),
      pingBettyDirect: el("pingBettyDirect"),
    };

    let lastData = [];
    let currentEvent = null;
    let currentMode = "OPEN";
    let chatHistory = [];
    let isDemoMode = false;

    let currentContextBundle = null;
    const contextCache = new Map();

    function esc(s){ return String(s ?? "").replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    function fmtDate(iso){
      try{
        const d = new Date(iso);
        return d.toLocaleString(undefined,{weekday:"short",day:"2-digit",month:"short",hour:"2-digit",minute:"2-digit"});
      }catch{ return iso; }
    }
    function dateOnlyISO(iso){
      try{
        const d = new Date(iso);
        const y = d.getUTCFullYear();
        const m = String(d.getUTCMonth()+1).padStart(2,"0");
        const da = String(d.getUTCDate()).padStart(2,"0");
        return `${y}-${m}-${da}`;
      }catch{ return String(iso||"").slice(0,10); }
    }
    function chosenSport(){
      return ($.sport.value === "custom" && $.sportCustom.value.trim())
        ? $.sportCustom.value.trim()
        : $.sport.value;
    }
    function isSoccerSportKey(sk){
      return /^soccer_/i.test(String(sk||""));
    }
    function showNotice(txt){
      $.notice.textContent = txt;
      $.notice.classList.remove("hidden");
    }
    function hideNotice(){ $.notice.classList.add("hidden"); }

    function safeJson(obj){
      const s = JSON.stringify(obj || {});
      return s.replace(/</g, "\\u003c").replace(/>/g, "\\u003e").replace(/&/g, "\\u0026");
    }
    function dbgWrite(obj){
      try{
        $.dbgOut.textContent = typeof obj === "string" ? obj : JSON.stringify(obj,null,2);
      }catch{
        $.dbgOut.textContent = String(obj);
      }
    }
    async function fetchJsonWithDebug(url, opts){
      const r = await fetch(url, opts);
      const txt = await r.text().catch(()=> "");
      let json = null;
      try{ json = txt ? JSON.parse(txt) : null; }catch{ json = null; }
      if (!r.ok){
        const err = new Error(`HTTP ${r.status} ${r.statusText}`);
        err._debug = { url: String(url), status:r.status, statusText:r.statusText, body: txt?.slice(0,2000) };
        throw err;
      }
      return json ?? txt;
    }

    function teamLogoUrl(teamName){
      const name = String(teamName || "").trim();
      if (!name) return null;
      const q = encodeURIComponent(name);
      return `https://ui-avatars.com/api/?name=${q}&background=fff7ed&color=0f172a&rounded=true&bold=true&size=64`;
    }
    function setLogoNode(node, teamName, logoUrl){
      node.classList.remove("fallback");
      node.innerHTML = "";
      const url = logoUrl || teamLogoUrl(teamName);

      if (!url){
        node.classList.add("fallback");
        node.textContent = (teamName||"?").slice(0,1).toUpperCase();
        return;
      }

      const img = document.createElement("img");
      img.alt = teamName || "logo";
      img.src = url;
      img.loading = "lazy";
      img.referrerPolicy = "no-referrer";
      img.onerror = () => {
        node.innerHTML = "";
        node.classList.add("fallback");
        node.textContent = (teamName||"?").slice(0,1).toUpperCase();
      };
      node.appendChild(img);
    }

    function addBettyBubble(text){
      $.chatFeed.insertAdjacentHTML("beforeend", `
        <div class="bubbleRow">
          <div class="avatar" aria-hidden="true" style="width:30px;height:30px;font-size:16px;">üßô‚Äç‚ôÄÔ∏è</div>
          <div style="display:flex;flex-direction:column;gap:4px;">
            <div class="miniName">Betty</div>
            <div class="bubble bubbleBetty">${esc(text)}</div>
          </div>
        </div>
      `);
      $.chatFeed.scrollTop = $.chatFeed.scrollHeight;
    }
    function addWarn(text){
      $.chatFeed.insertAdjacentHTML("beforeend", `
        <div class="bubbleRow">
          <div class="bubble bubbleBetty" style="border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.06);">
            ‚ùå ${esc(text)}
          </div>
        </div>
      `);
      $.chatFeed.scrollTop = $.chatFeed.scrollHeight;
    }
    function addUserBubble(text){
      $.chatFeed.insertAdjacentHTML("beforeend", `
        <div class="bubbleRow">
          <div class="bubble bubbleUser">${esc(text)}</div>
        </div>
      `);
      $.chatFeed.scrollTop = $.chatFeed.scrollHeight;
    }
    function addThinking(){
      const id = "t_" + Math.random().toString(36).slice(2);
      $.chatFeed.insertAdjacentHTML("beforeend", `
        <div id="${id}" class="bubbleRow">
          <div class="avatar" aria-hidden="true" style="width:30px;height:30px;font-size:16px;">üßô‚Äç‚ôÄÔ∏è</div>
          <div style="display:flex;flex-direction:column;gap:4px;">
            <div class="miniName">Betty</div>
            <div class="bubble bubbleBetty" style="opacity:.75;font-style:italic;">Sto pensando‚Ä¶</div>
          </div>
        </div>
      `);
      $.chatFeed.scrollTop = $.chatFeed.scrollHeight;
      return id;
    }
    function removeThinking(id){
      const n = document.getElementById(id);
      if (n) n.remove();
    }

    function bestOddsFromBookmakers(bookmakers, marketKey, outcomeName){
      const list = Array.isArray(bookmakers) ? bookmakers : [];
      let best = null;

      for (const bm of list){
        const markets = Array.isArray(bm?.markets) ? bm.markets : [];
        const m = markets.find(x => x?.key === marketKey);
        if (!m) continue;

        const outcomes = Array.isArray(m?.outcomes) ? m.outcomes : [];
        const o = outcomes.find(x => String(x?.name || "").toLowerCase() === String(outcomeName).toLowerCase());
        const price = o?.price;

        if (typeof price === "number" && price > 0){
          if (best == null || price > best) best = price;
        }
      }
      return best;
    }
    function bestTotalForPoint(bookmakers, point, overOrUnder){
      const list = Array.isArray(bookmakers) ? bookmakers : [];
      let best = null;

      for (const bm of list){
        const markets = Array.isArray(bm?.markets) ? bm.markets : [];
        const m = markets.find(x => x?.key === "totals");
        if (!m) continue;

        const outcomes = Array.isArray(m?.outcomes) ? m.outcomes : [];
        const o = outcomes.find(x =>
          String(x?.name || "").toLowerCase() === String(overOrUnder).toLowerCase()
          && Number(x?.point) === Number(point)
        );

        const price = o?.price;
        if (typeof price === "number" && price > 0){
          if (best == null || price > best) best = price;
        }
      }
      return best;
    }
    function normalizeOddsEvent(ev){
      const home = ev?.home_team;
      const away = ev?.away_team;
      const bms = ev?.bookmakers;

      const qHome = bestOddsFromBookmakers(bms, "h2h", home);
      const qAway = bestOddsFromBookmakers(bms, "h2h", away);
      const qDraw = bestOddsFromBookmakers(bms, "h2h", "Draw");

      let line = null;
      outer: for (const bm of (Array.isArray(bms) ? bms : [])){
        for (const m of (Array.isArray(bm?.markets) ? bm.markets : [])){
          if (m?.key !== "totals") continue;
          const outs = Array.isArray(m?.outcomes) ? m.outcomes : [];
          const first = outs.find(x => typeof x?.point === "number");
          if (first){
            line = first.point;
            break outer;
          }
        }
      }

      const qOver = (line != null) ? bestTotalForPoint(bms, line, "Over") : null;
      const qUnder = (line != null) ? bestTotalForPoint(bms, line, "Under") : null;

      return {
        id: ev?.id,
        commence_time: ev?.commence_time,
        home_team: home,
        away_team: away,
        outcomes: [
          { name:"Home", prob: null, odds: qHome },
          { name:"Draw", prob: null, odds: qDraw },
          { name:"Away", prob: null, odds: qAway },
        ],
        totals: (line != null) ? [
          { point: line, outcomes: [
            { name:"Over", prob: null, odds: qOver },
            { name:"Under", prob: null, odds: qUnder },
          ]}
        ] : [],
        _raw: ev
      };
    }

    async function fetchEvents(){
      const sport = chosenSport();
      const regions = $.regions.value;

      const url = new URL(ODDS_BASE + "/get-odds");
      url.searchParams.set("sport", sport);
      url.searchParams.set("regions", regions);
      url.searchParams.set("live", "false");
      url.searchParams.set("count", String(MAX_COUNT));
      url.searchParams.set("markets", "h2h,totals");

      return fetchJsonWithDebug(url, { headers:{ "Accept":"application/json" }});
    }

    function setDemoMode(on){
      isDemoMode = !!on;
      $.chipMode.textContent = on ? "modalit√†: demo" : "modalit√†: live";
    }

    async function hubResolve(home, away, dateStr){
      const url = new URL(FOOTBALL_HUB_BASE + "/resolve");
      url.searchParams.set("home", home);
      url.searchParams.set("away", away);
      url.searchParams.set("date", dateStr);
      return fetchJsonWithDebug(url, { headers:{ "Accept":"application/json" }});
    }
    async function hubContextByFixtureKey(fixtureKey){
      const url = new URL(FOOTBALL_HUB_BASE + "/context");
      url.searchParams.set("fixture_key", String(fixtureKey));
      return fetchJsonWithDebug(url, { headers:{ "Accept":"application/json" }});
    }
    async function hubContextByTeams(home, away, dateStr){
      const url = new URL(FOOTBALL_HUB_BASE + "/context");
      url.searchParams.set("home", home);
      url.searchParams.set("away", away);
      url.searchParams.set("date", dateStr);
      return fetchJsonWithDebug(url, { headers:{ "Accept":"application/json" }});
    }
    async function getContextBundleForEvent(ev){
      const home = ev?.home_team;
      const away = ev?.away_team;
      const dateStr = dateOnlyISO(ev?.commence_time);
      const key = `${home}__${away}__${dateStr}`;

      if (contextCache.has(key)) return contextCache.get(key);

      if (isDemoMode){
        const bundle = { ok:false, reason:"demo", resolve:null, context:null, fixture_key:null };
        contextCache.set(key, bundle);
        return bundle;
      }

      const res = await hubResolve(home, away, dateStr);
      const fixtureKey = res?.fixture_key || null;

      if (!res?.ok || !fixtureKey){
        const bundle = { ok:false, reason:"resolve_failed", resolve:res || null, context:null, fixture_key:null };
        contextCache.set(key, bundle);
        return bundle;
      }

      let ctx = await hubContextByFixtureKey(fixtureKey);
      if (!ctx?.ok){
        ctx = await hubContextByTeams(home, away, dateStr);
      }

      const bundle = {
        ok: !!ctx?.ok,
        reason: ctx?.ok ? "ok" : "context_not_ok",
        resolve: res,
        context: ctx,
        fixture_key: fixtureKey
      };

      contextCache.set(key, bundle);
      return bundle;
    }

    function emptyState(msg){
      return `
        <div class="bg-white rounded-2xl border p-6 text-center text-slate-600 cardShadow" style="border-color:rgba(2,6,23,.10);">
          ${esc(msg)}
        </div>
      `;
    }

    async function load(){
      $.status.textContent = "stato: carico‚Ä¶";
      $.chipContext.textContent = "context: ‚Äî";
      hideNotice();

      try{
        const data = await fetchEvents();

        const rate = data?.rate || {};
        $.rate.textContent = `rate: remaining=${rate.remaining ?? "?"} used=${rate.used ?? "?"}`;

        const remaining = Number(rate.remaining ?? NaN);
        const mustDemo = (data?.ok === false) || (Number.isFinite(remaining) && remaining <= 0);

        if (mustDemo){
          setDemoMode(true);
          showNotice(`‚ö†Ô∏è DEMO attiva: remaining=${rate.remaining ?? "?"}.`);
          lastData = buildDemoEvents();
          $.status.textContent = "stato: demo";
          $.chipCount.textContent = `match: ${lastData.length || 0}`;
          renderCards(lastData);
          return;
        }

        setDemoMode(false);

        const rawEvents = Array.isArray(data?.data) ? data.data : [];
        lastData = rawEvents.map(normalizeOddsEvent);

        $.chipCount.textContent = `match: ${lastData.length || 0}`;

        if (!lastData.length){
          $.cards.innerHTML = emptyState("Nessun match trovato. Cambia sport o riprova.");
          $.status.textContent = "stato: ok (0)";
          return;
        }

        renderCards(lastData);
        $.status.textContent = "stato: ok";
      }catch(e){
        const dbg = e?._debug || null;
        if (dbg){
          showNotice(`‚ùå get-odds fallito: ${e.message}. Vedi Debug Panel.`);
          dbgWrite({ where:"fetchEvents(get-odds)", ...dbg });
        }else{
          showNotice(`‚ùå get-odds fallito: ${String(e?.message || e)}. Vedi Debug Panel.`);
          dbgWrite({ where:"fetchEvents(get-odds)", error: String(e?.message || e) });
        }

        setDemoMode(true);
        lastData = buildDemoEvents();
        $.chipCount.textContent = `match: ${lastData.length || 0}`;
        renderCards(lastData);
        $.status.textContent = "stato: demo";
      }
    }

    function renderCards(events){
      $.cards.innerHTML = events.map(renderCard).join("");
    }

    function renderCard(ev){
      const when = fmtDate(ev.commence_time);

      const h = esc(ev.home_team||"");
      const a = esc(ev.away_team||"");
      const hInitial = esc((ev.home_team||"H").slice(0,1).toUpperCase());
      const aInitial = esc((ev.away_team||"A").slice(0,1).toUpperCase());

      const h2h = Array.isArray(ev.outcomes) ? ev.outcomes : [];
      const totals = Array.isArray(ev.totals) ? ev.totals : [];

      const qHome = h2h.find(x => /home/i.test(x.name))?.odds ?? null;
      const qDraw = h2h.find(x => /draw/i.test(x.name))?.odds ?? null;
      const qAway = h2h.find(x => /away/i.test(x.name))?.odds ?? null;

      const t0 = totals[0];
      const line = t0?.point ?? null;
      const qOver = t0?.outcomes?.find(x=>/over/i.test(x.name))?.odds ?? null;
      const qUnder = t0?.outcomes?.find(x=>/under/i.test(x.name))?.odds ?? null;

      const pill = (v)=> (typeof v === "number" ? `<span class="chip" style="font-weight:900;">${esc(v.toFixed(2))}</span>` : `<span class="chip" style="opacity:.6;">‚Äî</span>`);

      return `
        <article class="bg-white rounded-2xl border p-4 md:p-5 cardShadow" style="border-color:rgba(2,6,23,.10);">
          <div class="flex items-start justify-between gap-3">
            <div>
              <h3 class="text-lg font-extrabold tracking-tight text-slate-900">
                ${h} <span class="text-slate-400">vs</span> ${a}
              </h3>
              <div class="text-xs text-slate-500 mt-1">${esc(when)}</div>
            </div>
            <span class="chip">${isDemoMode ? "demo" : "live"}</span>
          </div>

          <div class="mt-3 rounded-2xl border p-3 flex items-center gap-2" style="border-color:rgba(2,6,23,.08);">
            <div class="tlogo" title="${h}">
              <img src="${esc(teamLogoUrl(ev.home_team) || '')}" alt="${h}" loading="lazy" referrerpolicy="no-referrer"
                   onerror="this.remove(); this.parentElement.textContent='${hInitial}'">
            </div>
            <div class="text-sm font-extrabold text-slate-900">${h}</div>
            <span class="vsPill">VS</span>
            <div class="tlogo" title="${a}">
              <img src="${esc(teamLogoUrl(ev.away_team) || '')}" alt="${a}" loading="lazy" referrerpolicy="no-referrer"
                   onerror="this.remove(); this.parentElement.textContent='${aInitial}'">
            </div>
            <div class="text-sm font-extrabold text-slate-900">${a}</div>
          </div>

          <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-3">
            <div class="rounded-2xl border p-3" style="border-color:rgba(2,6,23,.08);">
              <div class="text-xs font-extrabold text-slate-900 mb-2">Quote 1X2 (migliori)</div>
              <div class="flex items-center justify-between text-sm"><span>${h}</span>${pill(qHome)}</div>
              <div class="flex items-center justify-between text-sm mt-2"><span>Pareggio</span>${pill(qDraw)}</div>
              <div class="flex items-center justify-between text-sm mt-2"><span>${a}</span>${pill(qAway)}</div>
            </div>

            <div class="rounded-2xl border p-3" style="border-color:rgba(2,6,23,.08);">
              <div class="text-xs font-extrabold text-slate-900 mb-2">Under/Over ${line ? `(linea ${esc(line)})` : ""}</div>
              <div class="flex items-center justify-between text-sm"><span>Over</span>${pill(qOver)}</div>
              <div class="flex items-center justify-between text-sm mt-2"><span>Under</span>${pill(qUnder)}</div>
              <div class="text-[12px] text-slate-500 mt-2">Quote ‚Äúbest‚Äù tra bookmaker.</div>
            </div>
          </div>

          <div class="mt-4 flex items-center justify-end">
            <button class="btn btnPrimary" onclick='openBetty(${safeJson(ev)})'>
              Leggi il Pronostico di Bettyüßô‚Äç‚ôÄÔ∏è
            </button>
          </div>
        </article>
      `;
    }

    function openModal(){
      $.overlay.classList.add("show");
      $.overlay.setAttribute("aria-hidden","false");
      document.body.style.overflow = "hidden";
      setTimeout(()=> $.chatInput.focus(), 60);
    }
    function closeModal(){
      $.overlay.classList.remove("show");
      $.overlay.setAttribute("aria-hidden","true");
      document.body.style.overflow = "";
    }

    function setMode(mode){
      currentMode = mode;
      $.tabBtns.forEach(b=>{
        if (b.classList.contains("hidden")) return;
        b.classList.toggle("active", b.dataset.mode === mode);
      });
    }

    function setTabsForSport(sportKey){
      const soccer = isSoccerSportKey(sportKey);
      $.tabBTTS.classList.toggle("hidden", !soccer);
      $.tabEXACT.classList.toggle("hidden", !soccer);
      $.tabSCORER.classList.toggle("hidden", !soccer);
      $.tabTOTALS.classList.remove("hidden");

      const active = $.tabBtns.find(b=>b.classList.contains("active"));
      if (active && active.classList.contains("hidden")){
        setMode("OPEN");
      }
    }

    /* ====== FIX QUI: prompt ‚Äústrong‚Äù che obbliga la previsione subito ====== */
    function buildStrongMarketRequest(mode, ev){
      const line = ev?.totals?.[0]?.point ?? null;
      const hasLine = (typeof line === "number");

      if (mode === "TOTALS"){
        return hasLine
          ? `Dammi SUBITO una previsione Under/Over sulla linea ${line}. Scegli una sola giocata principale (Over o Under) e motivala con 3 punti (quote + contesto). Poi proponi una giocata alternativa pi√π prudente.`
          : `Dammi SUBITO una previsione Under/Over. Se manca la linea, assumi 2.5 come default e dichiaralo chiaramente. Scegli una giocata principale e motivala.`;
      }
      if (mode === "BTTS"){
        return `Dammi SUBITO una previsione Gol/NoGol (BTTS): scegli una sola giocata principale (Gol o NoGol) e motivala con 3 punti. Poi un‚Äôalternativa prudente.`;
      }
      if (mode === "EXACT"){
        return `Dammi SUBITO 2 risultati esatti pi√π probabili (con percentuali indicative o livello fiducia) e motivali in modo discorsivo.`;
      }
      if (mode === "SCORER"){
        return `Dammi SUBITO 1‚Äì3 possibili marcatori SOLO se presenti nel contesto. Se nel contesto non ci sono nomi, dillo e proponi una strategia alternativa (es. "marcatore: no bet" o mercati diversi).`;
      }
      return `Dammi SUBITO una previsione principale (1X2 o doppia chance) e motivala con 3 punti basati su quote e contesto. Poi proponi una alternativa prudente.`;
    }

    function buildAntiHallucinationPrompt(userText, mode, bundle){
      const hasCtx = !!(bundle && bundle.ok && bundle.context && bundle.context.context);
      const ctxNote = hasCtx
        ? "Hai un CONTEXTO dati (classifica/forma/infortuni/marcatori/h2h). Usalo."
        : "NON hai contesto: NON inventare dati (classifica, forma, indisponibili, marcatori). D√¨ chiaramente che mancano.";

      return [
        "REGOLA ASSOLUTA:",
        "- Non inventare NESSUN dato su rosa, indisponibili, classifica, ultimi risultati.",
        "- Usa SOLO ci√≤ che trovi in `context` quando presente.",
        "- Se manca un dato, scrivi: 'Questo dato non √® disponibile nel contesto'.",
        "",
        "OBBLIGO DI OUTPUT:",
        "- NON dire: 'Ok üëç dimmi cosa vuoi sapere'.",
        "- Devi dare SUBITO una previsione completa per il mercato richiesto.",
        "- Struttura: (1) Giocata principale + motivazione breve (2) Alternativa prudente (3) Livello fiducia (basso/medio/alto).",
        "- Chiudi SEMPRE con 1 domanda breve per far continuare l'utente (es. 'Vuoi anche 1X2 o Risultato Esatto?').",
        "",
        ctxNote,
        "",
        "RICHIESTA UTENTE:",
        userText || ""
      ].join("\n");
    }

    function extractBettyText(data){
      if (!data) return "";
      if (typeof data === "string") return data.trim();
      const text =
        (data.content ?? data.output_text ?? data.text ?? data.message ?? data.answer ?? data.result ?? "").toString().trim();
      if (text) return text;

      const text2 =
        (data?.data?.content ?? data?.data?.message ?? data?.data?.answer ?? "").toString().trim();
      if (text2) return text2;

      try { return JSON.stringify(data).slice(0, 2000); } catch { return ""; }
    }

    async function postJson(url, payload){
      return fetchJsonWithDebug(url, {
        method:"POST",
        headers:{ "Content-Type":"application/json", "Accept":"application/json" },
        body: JSON.stringify(payload)
      });
    }

    async function askBetty(userText){
      if (!currentEvent){
        addBettyBubble("Seleziona prima un match üòä");
        return "";
      }

      const sportKey = chosenSport();

      const payload = {
        mode: currentMode,
        prompt: buildAntiHallucinationPrompt(userText || "", currentMode, currentContextBundle),
        event: currentEvent,
        context: (currentContextBundle && currentContextBundle.ok) ? (currentContextBundle.context?.context || currentContextBundle.context) : null,
        resolve: (currentContextBundle && currentContextBundle.resolve) ? currentContextBundle.resolve : null,
        history: chatHistory.slice(-10),
        demo: isDemoMode,
        sport: sportKey
      };

      try{
        const data = await postJson(BETTY_BASE + "/chat", payload);
        const text = extractBettyText(data);
        if (!text) throw new Error("Risposta vuota da Betty");
        return text;
      }catch(e){
        const dbg = e?._debug || { where:"betty /chat", error:String(e?.message || e) };
        dbgWrite({ where:"askBetty", ...dbg });
        return `‚ö†Ô∏è Errore chiamata Betty.\nDettaglio: ${String(e?.message || e)}`;
      }
    }

    window.openBetty = async function(ev){
      currentEvent = ev;
      chatHistory = [];
      currentContextBundle = null;

      const sportKey = chosenSport();
      setTabsForSport(sportKey);

      $.chatTitle.textContent = `${ev.home_team} vs ${ev.away_team}`;
      $.chatSub.textContent = fmtDate(ev.commence_time);
      $.chatFeed.innerHTML = "";

      $.mhHomeName.textContent = ev.home_team || "Home";
      $.mhAwayName.textContent = ev.away_team || "Away";
      setLogoNode($.mhHomeLogo, ev.home_team, null);
      setLogoNode($.mhAwayLogo, ev.away_team, null);

      setMode("OPEN");
      openModal();

      addBettyBubble("Ok, aggancio il contesto del match‚Ä¶");
      $.chipContext.textContent = "context: carico‚Ä¶";

      try{
        const bundle = await getContextBundleForEvent(ev);
        currentContextBundle = bundle;

        if (bundle && bundle.ok && bundle.context){
          $.chipContext.textContent = "context: ok";
          addBettyBubble("Perfetto ‚úÖ Contesto agganciato.");
        }else{
          $.chipContext.textContent = "context: NO";
          addWarn(`Non aggancio il contesto. Dettaglio: ${bundle?.reason || "unknown"}`);
        }
      }catch(err){
        $.chipContext.textContent = "context: NO";
        addWarn("Errore aggancio contesto. Far√≤ una lettura BASE senza inventare dati.");
      }

      const th = addThinking();
      const opening = await askBetty("Dammi SUBITO una analisi completa e una previsione principale + alternativa prudente.");
      removeThinking(th);

      addBettyBubble(opening);
      chatHistory.push({ role:"assistant", content: opening });
    }

    $.refresh.addEventListener("click", load);

    $.sport.addEventListener("change", () => {
      const custom = $.sport.value === "custom";
      $.sportCustom.classList.toggle("hidden", !custom);
      if (custom) $.sportCustom.focus();
    });

    /* ========= FIX TAB CLICK: invece di ‚Äúmodalit√† attiva‚Äù -> richiesta forte immediata ========= */
    $.tabBtns.forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        if (btn.classList.contains("hidden")) return;

        setMode(btn.dataset.mode);

        if (!currentEvent){
          addBettyBubble("Seleziona un match üòä");
          return;
        }

        const strong = buildStrongMarketRequest(btn.dataset.mode, currentEvent);

        // opzionale: non spammo la chat con "(richiesta rapida)" ogni volta, faccio solo una riga elegante
        addUserBubble(btn.textContent);
        chatHistory.push({ role:"user", content: strong });

        const th = addThinking();
        const ans = await askBetty(strong);
        removeThinking(th);

        addBettyBubble(ans);
        chatHistory.push({ role:"assistant", content: ans });
      });
    });

    $.sendBtn.addEventListener("click", async ()=>{
      const t = $.chatInput.value.trim();
      if (!t) return;
      $.chatInput.value = "";

      addUserBubble(t);
      chatHistory.push({ role:"user", content: t });

      const th = addThinking();
      const ans = await askBetty(t);
      removeThinking(th);

      addBettyBubble(ans);
      chatHistory.push({ role:"assistant", content: ans });
    });

    $.chatInput.addEventListener("keydown", (e)=>{
      if (e.key === "Enter" && !e.shiftKey){
        e.preventDefault();
        $.sendBtn.click();
      }
    });

    $.closeModal.addEventListener("click", closeModal);
    $.overlay.addEventListener("click", (e)=>{ if (e.target === $.overlay) closeModal(); });
    document.addEventListener("keydown", (e)=>{ if (e.key === "Escape" && $.overlay.classList.contains("show")) closeModal(); });

    $.pingOdds.addEventListener("click", async ()=>{
      try{
        const ok = await fetchJsonWithDebug(ODDS_BASE + "/", { headers:{Accept:"application/json"} });
        dbgWrite({ ping:"get-odds /", ok });
      }catch(e){
        dbgWrite({ ping:"get-odds /", error:String(e.message||e), debug:e._debug || null });
      }
    });
    $.pingHub.addEventListener("click", async ()=>{
      try{
        const ok = await fetchJsonWithDebug(FOOTBALL_HUB_BASE + "/", { headers:{Accept:"application/json"} });
        dbgWrite({ ping:"football-hub /", ok });
      }catch(e){
        dbgWrite({ ping:"football-hub /", error:String(e.message||e), debug:e._debug || null });
      }
    });
    $.pingBettyDirect.addEventListener("click", async ()=>{
      try{
        const res = await postJson(BETTY_BASE + "/chat", { ping:true });
        dbgWrite({ ping:"betty diretto /chat", res });
      }catch(e){
        dbgWrite({ ping:"betty diretto /chat", error:String(e.message||e), debug:e._debug || null });
      }
    });

    load();
  </script>
</body>
</html>
