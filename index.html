<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NextScore ‚Äî Match Center (Light)</title>

  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;800;900&display=swap" rel="stylesheet"/>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{
      --bg:#ffffff;
      --panel:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --border:rgba(2,6,23,.10);
      --shadow: 0 16px 40px rgba(2,6,23,.08);
      --accent:#f59e0b;
      --accent2:#fb923c;
      --soft:#fff7ed;
    }
    html,body{ font-family:Roboto,system-ui,-apple-system,"Segoe UI",Arial,sans-serif; background:var(--bg); color:var(--text); }
    .cardShadow{ box-shadow: var(--shadow); }
    .chip{
      font-size:12px; line-height:1;
      padding:6px 10px; border-radius:999px;
      border:1px solid var(--border);
      background: #fff;
      color:#0f172a;
      white-space:nowrap;
    }
    .btn{
      border-radius:14px;
      padding:10px 14px;
      font-weight:800;
      border:1px solid var(--border);
      background:#fff;
      transition: transform .08s ease, box-shadow .12s ease;
    }
    .btn:hover{ transform: translateY(-1px); box-shadow:0 10px 24px rgba(2,6,23,.10); }
    .btnPrimary{
      border:1px solid rgba(245,158,11,.35);
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent2) 100%);
      color:#111827;
    }
    .btnPrimary:hover{ box-shadow:0 16px 40px rgba(245,158,11,.22); }
    .input{
      width:100%;
      border-radius:14px;
      border:1px solid var(--border);
      background:#fff;
      padding:10px 12px;
      color:#0f172a;
      outline:none;
    }
    .input:focus{
      border-color: rgba(245,158,11,.55);
      box-shadow: 0 0 0 4px rgba(245,158,11,.14);
    }

    /* Modal */
    .modalOverlay{
      position:fixed; inset:0;
      background: rgba(2,6,23,.45);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding:14px;
      z-index:9999;
    }
    .modalOverlay.show{ display:flex; }
    .modal{
      width:100%;
      max-width:980px;
      background:#fff;
      border:1px solid var(--border);
      border-radius:22px;
      box-shadow: 0 24px 70px rgba(2,6,23,.22);
      overflow:hidden;
      max-height: 92vh;
      display:flex;
      flex-direction:column;
    }
    .modalHeader{
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 16px;
      border-bottom:1px solid var(--border);
      background: linear-gradient(180deg, #ffffff 0%, #fffaf2 100%);
    }
    .avatar{
      width:34px; height:34px;
      border-radius:999px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      background: #fff7ed;
      border:1px solid rgba(245,158,11,.30);
      font-size:18px;
      flex:0 0 auto;
      overflow:hidden;
    }
    .avatar img{ width:100%; height:100%; object-fit:cover; }

    .modalBody{
      padding:14px 14px 0 14px;
      overflow:auto;
    }
    .chatFeed{
      padding:4px 2px 12px 2px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .bubbleRow{
      display:flex;
      gap:10px;
      align-items:flex-end;
    }
    .bubble{
      max-width: 820px;
      border-radius:18px;
      padding:10px 12px;
      border:1px solid var(--border);
      background:#fff;
      line-height:1.35;
      font-size:14px;
      white-space:pre-wrap;
    }
    .bubbleUser{
      margin-left:auto;
      background:#111827;
      color:#fff;
      border:1px solid rgba(2,6,23,.18);
    }
    .bubbleBetty{ background:#fff; }
    .miniName{
      font-size:12px;
      color:#0f172a;
      font-weight:900;
      margin-bottom:2px;
    }
    .microTabs{
      display:flex;
      gap:8px;
      padding:10px 14px 0 14px;
      flex-wrap:wrap;
    }
    .tabBtn{
      border-radius:999px;
      padding:8px 12px;
      font-weight:900;
      font-size:12px;
      border:1px solid var(--border);
      background:#fff;
      color:#0f172a;
    }
    .tabBtn.active{
      border-color: rgba(245,158,11,.50);
      background: #fff7ed;
    }
    .modalFooter{
      border-top:1px solid var(--border);
      padding:10px 12px;
      display:flex;
      gap:10px;
      align-items:flex-end;
      background:#fff;
    }
    .textarea{
      width:100%;
      min-height:44px;
      max-height:120px;
      resize:none;
      border-radius:16px;
      border:1px solid var(--border);
      padding:10px 12px;
      outline:none;
      font-family:Roboto,system-ui,-apple-system,"Segoe UI",Arial,sans-serif;
    }
    .textarea:focus{
      border-color: rgba(245,158,11,.55);
      box-shadow: 0 0 0 4px rgba(245,158,11,.14);
    }
    @media (min-width: 900px){
      .modalOverlay{ align-items:center; }
      .modal{ max-height: 86vh; }
    }

    .teamRow{
      display:flex; align-items:center; gap:10px;
      margin-top:8px;
      flex-wrap:wrap;
    }
    .teamPill{
      display:flex; align-items:center; gap:8px;
      padding:6px 10px;
      border:1px solid var(--border);
      border-radius:999px;
      background:#fff;
      font-size:12px;
      font-weight:800;
      color:#0f172a;
    }
    .teamLogo{
      width:18px;height:18px;border-radius:999px;
      object-fit:cover;
    }
  </style>
</head>

<body>
  <div class="max-w-6xl mx-auto px-4 py-6 md:py-8">
    <header class="flex items-start md:items-center justify-between gap-4 mb-6">
      <div>
        <h1 class="text-2xl md:text-3xl font-extrabold tracking-tight">
          NextScore <span class="text-amber-600">Match Center</span>
        </h1>
        <p class="text-sm md:text-base text-slate-600 mt-1">
          Seleziona un match e leggi l‚Äôanalisi di <strong>Betty</strong> (senza quote).
        </p>
      </div>

      <div class="text-xs text-slate-500 text-right">
        <div id="rateInfo">rate: ‚Ä¶</div>
        <div id="statusInfo">stato: pronto</div>
      </div>
    </header>

    <section class="bg-white rounded-2xl border cardShadow" style="border-color:var(--border);">
      <div class="p-4 md:p-5">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
          <div class="md:col-span-2">
            <label class="block text-sm font-bold text-slate-800 mb-1">Sport / Campionato</label>
            <select id="sport" class="input">
              <option value="soccer_italy_serie_a">Calcio ‚Äî Serie A</option>
              <option value="soccer_epl">Calcio ‚Äî Premier League</option>
              <option value="soccer_spain_la_liga">Calcio ‚Äî La Liga</option>
              <option value="basketball_nba">Basket ‚Äî NBA</option>
              <option value="tennis_atp">Tennis ‚Äî ATP</option>
              <option value="custom">‚Äî Altro (custom) ‚Äî</option>
            </select>
            <input id="sportCustom" type="text" class="input mt-2 hidden" placeholder="es. soccer_uefa_champs_league" />
            <div class="text-[12px] text-slate-500 mt-1">
              Suggerimento: per le coppe europee useremo la voce custom (es. Champions/Europa).
            </div>
          </div>

          <div>
            <label class="block text-sm font-bold text-slate-800 mb-1">Regione</label>
            <select id="regions" class="input">
              <option value="eu">EU</option>
              <option value="uk">UK</option>
              <option value="us">US</option>
              <option value="au">AU</option>
            </select>
          </div>

          <div class="flex items-end gap-2">
            <button id="refreshBtn" class="btn btnPrimary w-full">Aggiorna Match</button>
          </div>
        </div>

        <div class="mt-4 flex flex-wrap items-center gap-2">
          <span class="chip" id="chipCount">match: ‚Äî</span>
          <span class="chip" id="chipMode">modalit√†: live</span>
          <span class="chip">stile: light premium</span>
          <span class="chip">AI: Betty üßô‚Äç‚ôÄÔ∏è</span>
        </div>
      </div>
    </section>

    <div id="notice" class="hidden mt-4 rounded-2xl border px-4 py-3 text-sm"
         style="border-color: rgba(245,158,11,.30); background: var(--soft); color:#7c2d12;">
    </div>

    <section id="cards" class="mt-5 grid gap-4 md:grid-cols-2"></section>
  </div>

  <!-- CHAT MODAL -->
  <div id="modalOverlay" class="modalOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Chat Betty">
      <div class="modalHeader">
        <div class="flex items-center gap-3">
          <div class="avatar" aria-hidden="true">üßô‚Äç‚ôÄÔ∏è</div>
          <div>
            <div class="text-sm font-extrabold leading-tight">Betty</div>
            <div id="chatSub" class="text-xs text-slate-500">Seleziona un match per iniziare</div>
          </div>
        </div>

        <button id="closeModal" class="btn" style="padding:8px 12px;">Chiudi</button>
      </div>

      <div class="microTabs" id="tabsBar">
        <button class="tabBtn active" data-mode="OPEN">Analisi</button>
        <button class="tabBtn" data-mode="TOTALS">Under/Over</button>
        <button class="tabBtn" data-mode="BTTS">Gol/NoGol</button>
        <button class="tabBtn" data-mode="EXACT">Risultato Esatto</button>
        <button class="tabBtn" data-mode="SCORER">Marcatore</button>
      </div>

      <div class="modalBody">
        <div id="chatTitle" class="text-sm font-extrabold text-slate-900 mt-2 mb-2"></div>

        <div id="teamsRow" class="teamRow hidden"></div>

        <div id="chatFeed" class="chatFeed"></div>
      </div>

      <div class="modalFooter">
        <textarea id="chatInput" class="textarea" rows="2" placeholder="Scrivi una domanda (es. 'Che partita sar√†?')"></textarea>
        <button id="sendBtn" class="btn btnPrimary" style="min-width:120px;">Invia</button>
      </div>
    </div>
  </div>

  <script>
    /* ===== CONFIG ===== */
    const SERVICE_BASE   = "https://get-odds-299332443653.europe-west8.run.app";
    const BETTY_CHAT_URL = "https://betty-chat-299332443653.europe-west8.run.app";

    // ‚úÖ METTI QUI IL TUO CLOUD RUN football-hub
    const FOOTBALL_HUB_BASE = "https://football-hub-299332443653.europe-west8.run.app";

    const MAX_COUNT = 500; // mostra "tutte" (comunque limitato dal backend/mercati)
    const TZ_DEFAULT = "Europe/Rome";
    const SEASON_DEFAULT = "2025";

    /* ===== DEMO DATA (fallback quando rate=0 o ok=false) ===== */
    function buildDemoEvents(){
      const now = Date.now();
      const mk = (id, home, away, mins) => ({
        id,
        commence_time: new Date(now + mins*60*1000).toISOString(),
        home_team: home,
        away_team: away,
        outcomes: [
          { name:"Home", prob: 48.5, odds: null },
          { name:"Draw", prob: 26.0, odds: null },
          { name:"Away", prob: 25.5, odds: null },
        ],
        totals: [
          { point: 2.5, outcomes:[ {name:"Over", prob:52.0, odds:null}, {name:"Under", prob:48.0, odds:null} ] }
        ],
        btts: { outcomes:[ {name:"Yes", prob:55.0, odds:null}, {name:"No", prob:45.0, odds:null} ] }
      });
      return [
        mk("demo_1","Arsenal","Liverpool",90),
        mk("demo_2","Inter","Juventus",140),
        mk("demo_3","Real Madrid","Barcelona",210),
        mk("demo_4","PSG","Marseille",260),
        mk("demo_5","Bayern","Dortmund",320),
        mk("demo_6","Milan","Napoli",380),
        mk("demo_7","Atalanta","Roma",430),
        mk("demo_8","Chelsea","Man City",500),
      ];
    }

    /* ===== DOM ===== */
    const el = (id) => document.getElementById(id);
    const $ = {
      rate: el("rateInfo"),
      status: el("statusInfo"),
      notice: el("notice"),
      cards: el("cards"),
      chipCount: el("chipCount"),
      chipMode: el("chipMode"),

      sport: el("sport"),
      sportCustom: el("sportCustom"),
      regions: el("regions"),
      refresh: el("refreshBtn"),

      overlay: el("modalOverlay"),
      closeModal: el("closeModal"),
      chatTitle: el("chatTitle"),
      chatSub: el("chatSub"),
      chatFeed: el("chatFeed"),
      chatInput: el("chatInput"),
      sendBtn: el("sendBtn"),
      tabsBar: el("tabsBar"),
      teamsRow: el("teamsRow"),
      tabBtns: Array.from(document.querySelectorAll(".tabBtn")),
    };

    /* ===== STATE ===== */
    let lastData = [];
    let currentEvent = null;
    let currentMode = "OPEN";
    let chatHistory = [];
    let isDemoMode = false;

    /* ===== HELPERS ===== */
    function esc(s){ return String(s ?? "").replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    function fmtDate(iso){
      try{
        const d = new Date(iso);
        return d.toLocaleString(undefined,{weekday:"short",day:"2-digit",month:"short",hour:"2-digit",minute:"2-digit"});
      }catch{ return iso; }
    }
    function isoDateOnly(iso){
      try{
        const d = new Date(iso);
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth()+1).padStart(2,"0");
        const dd = String(d.getDate()).padStart(2,"0");
        return `${yyyy}-${mm}-${dd}`;
      }catch{
        return "";
      }
    }

    function chosenSport(){
      return ($.sport.value === "custom" && $.sportCustom.value.trim())
        ? $.sportCustom.value.trim()
        : $.sport.value;
    }
    function isSoccerSport(){
      const s = chosenSport();
      return /^soccer_/i.test(s);
    }
    function bestOutcome(outcomes=[]){
      return [...outcomes].sort((a,b)=>(b.prob||0)-(a.prob||0))[0];
    }
    function toItOutcome(name=""){
      return /draw/i.test(name) ? "Pareggio" : /yes/i.test(name) ? "Gol" : /no/i.test(name) ? "No Gol" : name;
    }
    function showNotice(txt){
      $.notice.textContent = txt;
      $.notice.classList.remove("hidden");
    }
    function hideNotice(){ $.notice.classList.add("hidden"); }

    function emptyState(msg){
      return `
        <div class="bg-white rounded-2xl border p-6 text-center text-slate-600 cardShadow" style="border-color:var(--border);">
          ${esc(msg)}
        </div>
      `;
    }

    function setDemoMode(on){
      isDemoMode = !!on;
      $.chipMode.textContent = on ? "modalit√†: demo" : "modalit√†: live";
    }

    function safeJson(obj){
      const s = JSON.stringify(obj || {});
      return s.replace(/</g, "\\u003c").replace(/>/g, "\\u003e").replace(/&/g, "\\u0026");
    }

    /* ===== API (ODDS) ===== */
    async function fetchEvents(){
      const sport = chosenSport();
      const regions = $.regions.value;
      const url = new URL(SERVICE_BASE + "/get-odds");
      url.searchParams.set("sport", sport);
      url.searchParams.set("regions", regions);
      url.searchParams.set("live", "false");
      url.searchParams.set("count", String(MAX_COUNT));
      url.searchParams.set("markets", "h2h,totals,btts");
      const r = await fetch(url, { headers:{ "Accept":"application/json" }});
      return r.json();
    }

    /* ===== API (FOOTBALL HUB CONTEXT) ===== */
    async function fetchJson(url){
      const r = await fetch(url, { headers:{ "Accept":"application/json" }});
      let data = null;
      try{ data = await r.json(); }catch{}
      if (!r.ok) throw new Error(data?.error || data?.message || ("HTTP "+r.status));
      return data;
    }

    async function enrichSoccerContext(ev){
      // Se non √® calcio o siamo in demo ‚Üí non facciamo nulla
      if (!isSoccerSport() || isDemoMode) return { context: null, resolve: null };

      const date = isoDateOnly(ev.commence_time);
      if (!date) return { context: null, resolve: null };

      // 1) resolve fixture id
      const u1 = new URL(FOOTBALL_HUB_BASE + "/resolve");
      u1.searchParams.set("home", ev.home_team);
      u1.searchParams.set("away", ev.away_team);
      u1.searchParams.set("date", date);

      const resolved = await fetchJson(u1.toString());

      // resolved.fixture?.fixture?.id oppure resolved.response?.fixture?.id ‚Üí gestiamo entrambe
      const fixtureId =
        resolved?.fixture?.fixture?.id ||
        resolved?.fixture?.id ||
        resolved?.response?.fixture?.id ||
        resolved?.response?.[0]?.fixture?.id ||
        null;

      if (!fixtureId) return { context: null, resolve: resolved };

      // 2) context completo
      const u2 = new URL(FOOTBALL_HUB_BASE + "/context");
      u2.searchParams.set("fixture", String(fixtureId));

      const ctx = await fetchJson(u2.toString());

      return { context: ctx, resolve: resolved, fixtureId };
    }

    /* ===== LOAD + RENDER ===== */
    async function load(){
      $.status.textContent = "stato: carico‚Ä¶";
      hideNotice();

      try{
        const data = await fetchEvents();
        const rate = data?.rate || {};
        $.rate.textContent = `rate: remaining=${rate.remaining ?? "?"} used=${rate.used ?? "?"}`;

        const remaining = Number(rate.remaining ?? NaN);
        const mustDemo = (data?.ok === false) || (Number.isFinite(remaining) && remaining <= 0);

        if (mustDemo){
          setDemoMode(true);
          showNotice("‚ö†Ô∏è Limite chiamate raggiunto (remaining=0). Attivo la modalit√† DEMO per non fermare la pagina.");
          lastData = buildDemoEvents();
          $.status.textContent = "stato: demo";
          $.chipCount.textContent = `match: ${lastData.length || 0}`;
          renderCards(lastData);
          return;
        }

        setDemoMode(false);

        lastData = data.events || [];
        $.chipCount.textContent = `match: ${lastData.length || 0}`;

        if (!lastData.length){
          $.cards.innerHTML = emptyState("Nessun match trovato. Cambia sport o riprova.");
          $.status.textContent = "stato: ok (0)";
          return;
        }

        renderCards(lastData);
        $.status.textContent = "stato: ok";
      }catch(e){
        console.error(e);
        setDemoMode(true);
        showNotice("‚ö†Ô∏è Problema di rete/backend. Attivo la modalit√† DEMO.");
        lastData = buildDemoEvents();
        $.chipCount.textContent = `match: ${lastData.length || 0}`;
        renderCards(lastData);
        $.status.textContent = "stato: demo";
      }
    }

    function renderCards(events){
      $.cards.innerHTML = events.map(renderCard).join("");
    }

    function renderCard(ev){
      const pick = bestOutcome(ev.outcomes || []);
      const when = fmtDate(ev.commence_time);

      return `
        <article class="bg-white rounded-2xl border p-4 md:p-5 cardShadow" style="border-color:var(--border);">
          <div class="flex items-start justify-between gap-3">
            <div>
              <h3 class="text-lg font-extrabold tracking-tight text-slate-900">
                ${esc(ev.home_team)} <span class="text-slate-400">vs</span> ${esc(ev.away_team)}
              </h3>
              <div class="text-xs text-slate-500 mt-1">${esc(when)}</div>
            </div>
            <span class="chip">${isDemoMode ? "demo" : "live"}</span>
          </div>

          <div class="mt-3 text-sm text-slate-700">
            <span class="font-extrabold text-slate-900">Previsione (rapida):</span>
            ${pick ? `${esc(toItOutcome(pick.name))}` : "‚Äî"}
            <div class="text-xs text-slate-500 mt-1">(Niente quote qui: solo lettura e spiegazione.)</div>
          </div>

          <div class="mt-4 flex items-center justify-end">
            <button class="btn btnPrimary"
                    onclick='openBetty(${safeJson(ev)})'>
              Leggi il Pronostico di Bettyüßô‚Äç‚ôÄÔ∏è
            </button>
          </div>
        </article>
      `;
    }

    /* ===== MODAL ===== */
    function openModal(){
      $.overlay.classList.add("show");
      $.overlay.setAttribute("aria-hidden","false");
      document.body.style.overflow = "hidden";
      setTimeout(()=> $.chatInput.focus(), 60);
    }
    function closeModal(){
      $.overlay.classList.remove("show");
      $.overlay.setAttribute("aria-hidden","true");
      document.body.style.overflow = "";
    }

    function setMode(mode){
      currentMode = mode;
      $.tabBtns.forEach(b=>{
        b.classList.toggle("active", b.dataset.mode === mode);
      });
    }

    function addUserBubble(text){
      $.chatFeed.insertAdjacentHTML("beforeend", `
        <div class="bubbleRow">
          <div class="bubble bubbleUser">${esc(text)}</div>
        </div>
      `);
      $.chatFeed.scrollTop = $.chatFeed.scrollHeight;
    }

    function addBettyBubble(text){
      $.chatFeed.insertAdjacentHTML("beforeend", `
        <div class="bubbleRow">
          <div class="avatar" aria-hidden="true" style="width:30px;height:30px;font-size:16px;">üßô‚Äç‚ôÄÔ∏è</div>
          <div style="display:flex;flex-direction:column;gap:4px;">
            <div class="miniName">Betty</div>
            <div class="bubble bubbleBetty">${esc(text)}</div>
          </div>
        </div>
      `);
      $.chatFeed.scrollTop = $.chatFeed.scrollHeight;
    }

    function addThinking(){
      const id = "t_" + Math.random().toString(36).slice(2);
      $.chatFeed.insertAdjacentHTML("beforeend", `
        <div id="${id}" class="bubbleRow">
          <div class="avatar" aria-hidden="true" style="width:30px;height:30px;font-size:16px;">üßô‚Äç‚ôÄÔ∏è</div>
          <div style="display:flex;flex-direction:column;gap:4px;">
            <div class="miniName">Betty</div>
            <div class="bubble bubbleBetty" style="opacity:.75;font-style:italic;">Sto pensando‚Ä¶</div>
          </div>
        </div>
      `);
      $.chatFeed.scrollTop = $.chatFeed.scrollHeight;
      return id;
    }
    function removeThinking(id){
      const n = document.getElementById(id);
      if (n) n.remove();
    }

    function renderTeamsRowFromContext(ctx){
      // prova a prendere loghi da context (API-Football)
      // possibili path: ctx.context?.fixture?.teams?.home?.logo ecc
      const homeLogo =
        ctx?.context?.fixture?.teams?.home?.logo ||
        ctx?.fixture?.teams?.home?.logo ||
        null;

      const awayLogo =
        ctx?.context?.fixture?.teams?.away?.logo ||
        ctx?.fixture?.teams?.away?.logo ||
        null;

      if (!homeLogo && !awayLogo) {
        $.teamsRow.classList.add("hidden");
        $.teamsRow.innerHTML = "";
        return;
      }

      const hName = currentEvent?.home_team || "Home";
      const aName = currentEvent?.away_team || "Away";

      $.teamsRow.innerHTML = `
        <div class="teamPill">
          ${homeLogo ? `<img class="teamLogo" src="${esc(homeLogo)}" alt="${esc(hName)}" />` : ""}
          <span>${esc(hName)}</span>
        </div>
        <div class="teamPill">
          ${awayLogo ? `<img class="teamLogo" src="${esc(awayLogo)}" alt="${esc(aName)}" />` : ""}
          <span>${esc(aName)}</span>
        </div>
      `;
      $.teamsRow.classList.remove("hidden");
    }

    function updateTabsVisibility(){
      const soccer = isSoccerSport();
      $.tabsBar.style.display = soccer ? "flex" : "none";
      // se non calcio, blocchiamo i mode calcistici
      if (!soccer) {
        setMode("OPEN");
      }
    }

    /* ===== BETTY CALL ===== */
    function modeSeedPrompt(mode){
      // prompt ‚Äúguidato‚Äù per farle usare i dati che le passiamo
      if (mode === "TOTALS") return "Genera una lettura Under/Over (spiega ritmo, gol fatti/subiti, trend recente, h2h e indisponibili). Se non hai un dato nel contesto, dillo chiaramente.";
      if (mode === "BTTS")   return "Genera una lettura Gol/NoGol (BTTS). Usa forma, gol fatti/subiti, h2h, stile di gioco e indisponibili. Se manca un dato nel contesto, dillo.";
      if (mode === "EXACT")  return "Azzarda 1‚Äì2 risultati esatti plausibili basandoti su forma, gol fatti/subiti, h2h e indisponibili. Motivali. Se mancano dati, riduci confidenza.";
      if (mode === "SCORER") return "Suggerisci 1‚Äì3 possibili marcatori usando top scorers, ruoli (se presenti), forma e indisponibili. Se non hai rose/ruoli nel contesto, spiegalo e proponi solo in base ai marcatori e trend.";
      return "Analisi completa: classifica, forma (ultime), h2h, indisponibili, gol fatti/subiti. Chiudi con 1X2 pi√π probabile e perch√©. Se mancano dati nel contesto, dillo.";
    }

    async function askBetty(userText){
      if (!currentEvent){
        addBettyBubble("Seleziona prima un match üòä");
        return "";
      }

      const payload = {
        mode: currentMode,
        prompt: userText || "",
        event: currentEvent,
        context: currentEvent.__context || null, // ‚úÖ qui passa tutto il contesto del football-hub
        history: chatHistory.slice(-10),
        demo: isDemoMode
      };

      try{
        const r = await fetch(BETTY_CHAT_URL + "/chat", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        });

        let data = null;
        try{ data = await r.json(); }catch{}

        if (!r.ok) throw new Error(data?.error || data?.message || ("HTTP " + r.status));

        const text = String(data?.content || data?.output_text || data?.text || data?.message || "").trim();
        if (!text) throw new Error("Risposta vuota");
        return text;
      }catch(e){
        const pick = bestOutcome(currentEvent?.outcomes || []);
        const base = pick ? `Lettura rapida: scenario pi√π probabile **${toItOutcome(pick.name)}**.` : "Lettura rapida disponibile.";
        const hint =
          (currentMode === "TOTALS") ? "Under/Over: dimmi la linea (2.5 / 3.5) e azzardo lo scenario."
        : (currentMode === "BTTS") ? "Gol/NoGol: ti dico quale sembra pi√π coerente."
        : (currentMode === "EXACT") ? "Risultato esatto: posso azzardare 1‚Äì2 score realistici (solo gioco)."
        : (currentMode === "SCORER") ? "Marcatore: dimmi 1‚Äì2 nomi (o ruolo) e azzardo."
        : "Chiedimi: forma, ritmo, fasi, cosa aspettarti nel match.";
        return `${base}\n${hint}\n\n(Se betty-chat √® gi√π: modalit√† demo, niente dati.)`;
      }
    }

    /* ===== PUBLIC ===== */
    window.openBetty = async function(ev){
      currentEvent = ev;
      chatHistory = [];
      updateTabsVisibility();

      $.chatTitle.textContent = `${ev.home_team} vs ${ev.away_team}`;
      $.chatSub.textContent = fmtDate(ev.commence_time);
      $.chatFeed.innerHTML = "";
      $.teamsRow.classList.add("hidden");
      $.teamsRow.innerHTML = "";

      setMode("OPEN");
      openModal();

      // 1) carico contesto calcio (classifica/forma/h2h/injuries/topscorers)
      let ctx = null;
      if (isSoccerSport() && !isDemoMode) {
        const th0 = addThinking();
        try{
          const enriched = await enrichSoccerContext(ev);
          ctx = enriched?.context || null;
          currentEvent.__context = ctx;

          // prova a renderizzare i loghi se ci sono
          renderTeamsRowFromContext(ctx);

          removeThinking(th0);
          addBettyBubble("Ok, ho caricato classifica/forma/h2h/indisponibili. Procedo con l‚Äôanalisi üëá");
        }catch(err){
          console.error(err);
          removeThinking(th0);
          addBettyBubble("Non riesco a caricare il contesto (classifica/forma) in questo momento. Posso comunque fare una lettura ‚Äòleggera‚Äô.");
          currentEvent.__context = null;
        }
      } else {
        currentEvent.__context = null;
      }

      // 2) richiesta analisi
      const th = addThinking();
      const opening = await askBetty(modeSeedPrompt("OPEN"));
      removeThinking(th);

      addBettyBubble(opening);
      chatHistory.push({ role:"assistant", content: opening });
    }

    /* ===== EVENTS ===== */
    $.refresh.addEventListener("click", load);

    $.sport.addEventListener("change", () => {
      const custom = $.sport.value === "custom";
      $.sportCustom.classList.toggle("hidden", !custom);
      if (custom) $.sportCustom.focus();
      updateTabsVisibility();
    });

    $.tabBtns.forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        // Tabs solo per calcio: se non calcio, ignora
        if (!isSoccerSport()) return;

        setMode(btn.dataset.mode);

        // auto-risposta "ragionata" sul tab
        const th = addThinking();
        const seed = modeSeedPrompt(btn.dataset.mode);
        const ans = await askBetty(seed);
        removeThinking(th);

        addBettyBubble(ans);
        chatHistory.push({ role:"assistant", content: ans });
      });
    });

    $.sendBtn.addEventListener("click", async ()=>{
      const t = $.chatInput.value.trim();
      if (!t) return;
      $.chatInput.value = "";

      addUserBubble(t);
      chatHistory.push({ role:"user", content: t });

      const th = addThinking();
      const ans = await askBetty(t);
      removeThinking(th);

      addBettyBubble(ans);
      chatHistory.push({ role:"assistant", content: ans });
    });

    $.chatInput.addEventListener("keydown", (e)=>{
      if (e.key === "Enter" && !e.shiftKey){
        e.preventDefault();
        $.sendBtn.click();
      }
    });

    $.closeModal.addEventListener("click", closeModal);
    $.overlay.addEventListener("click", (e)=>{ if (e.target === $.overlay) closeModal(); });
    document.addEventListener("keydown", (e)=>{ if (e.key === "Escape" && $.overlay.classList.contains("show")) closeModal(); });

    /* ===== INIT ===== */
    updateTabsVisibility();
    load();
  </script>
</body>
</html>
